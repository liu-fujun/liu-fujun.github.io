<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>OpenStack负载均衡Octavia简介 | Liu's Blog</title><meta name="keywords" content="负载均衡,octavia"><meta name="author" content="Liu Fujun"><meta name="copyright" content="Liu Fujun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="什么是负载均衡负载均衡，英文名称为Load Balance，其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如FTP服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。 负载均衡的作用对多台服务器进行流量分发的服务。负载均衡可以通过流量分发扩展应用系统对外的服务能力，通过消除单点故障提升应用系统的可用性。  提高可用性和访问速度在单个可用区">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenStack负载均衡Octavia简介">
<meta property="og:url" content="https://liu-fujun.github.io/2022/01/26/octavia/index.html">
<meta property="og:site_name" content="Liu&#39;s Blog">
<meta property="og:description" content="什么是负载均衡负载均衡，英文名称为Load Balance，其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如FTP服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。 负载均衡的作用对多台服务器进行流量分发的服务。负载均衡可以通过流量分发扩展应用系统对外的服务能力，通过消除单点故障提升应用系统的可用性。  提高可用性和访问速度在单个可用区">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liu-fujun.github.io/img/openstack.png">
<meta property="article:published_time" content="2022-01-26T06:51:01.000Z">
<meta property="article:modified_time" content="2022-01-26T07:13:48.718Z">
<meta property="article:author" content="Liu Fujun">
<meta property="article:tag" content="OpenStack">
<meta property="article:tag" content="octavia">
<meta property="article:tag" content="负载均衡">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liu-fujun.github.io/img/openstack.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://liu-fujun.github.io/2022/01/26/octavia/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":false,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OpenStack负载均衡Octavia简介',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-26 15:13:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/LFJ.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"><i class="fa-fw fas fa-code"></i><span> 技术</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%85%B6%E4%BB%96/"><i class="fa-fw fas fa-folder"></i><span> 其他</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 管理</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/openstack.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Liu's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"><i class="fa-fw fas fa-code"></i><span> 技术</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%85%B6%E4%BB%96/"><i class="fa-fw fas fa-folder"></i><span> 其他</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 管理</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">OpenStack负载均衡Octavia简介</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-26T06:51:01.000Z" title="发表于 2022-01-26 14:51:01">2022-01-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-26T07:13:48.718Z" title="更新于 2022-01-26 15:13:48">2022-01-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/">技术文档</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="OpenStack负载均衡Octavia简介"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="什么是负载均衡"><a href="#什么是负载均衡" class="headerlink" title="什么是负载均衡"></a>什么是负载均衡</h3><p>负载均衡，英文名称为Load Balance，其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如FTP服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。</p>
<h3 id="负载均衡的作用"><a href="#负载均衡的作用" class="headerlink" title="负载均衡的作用"></a>负载均衡的作用</h3><p>对多台服务器进行流量分发的服务。负载均衡可以通过流量分发扩展应用系统对外的服务能力，通过消除单点故障提升应用系统的可用性。</p>
<ol>
<li>提高可用性和访问速度<br>在单个可用区或多个可用区内的多个目标之间自动分配流量。</li>
<li>运行状况检查<br>检测无法正常运行的目标、停止向它们发送流量，然后将负载分散到剩余的正常运行的目标上。</li>
<li>安全性功能<br>创建和管理与负载均衡器关联的安全组，以提供更多联网和安全选项。</li>
<li>TLS 终止<br>提供集成化证书管理和 SSL/TLS 解密，可以灵活地集中管理负载均衡器的 SSL 设置，并从应用程序上卸载 CPU 密集型工作。</li>
</ol>
<h3 id="负载均衡分类"><a href="#负载均衡分类" class="headerlink" title="负载均衡分类"></a>负载均衡分类</h3><ol>
<li>软负载均衡<ul>
<li>软件实现负载均衡</li>
</ul>
</li>
<li>硬负载均衡<ul>
<li>硬件设备</li>
</ul>
</li>
<li>四层/七层负载均衡<ul>
<li>二层的就是基于MAC地址，二层负载均衡会通过一个虚拟MAC地址接受请求，然后再分配到真实的MAC地址。</li>
<li>三层负载就是通过一个虚拟IP地址，然后再分配到真实的IP。</li>
<li>四层就是通过虚机的IP+端口接收请求，然后再分配到真实的服务器；</li>
<li>七层就是通过虚机主机名或者URL接收请求，再根据一些规则分配到真实的服务器，常见的应用是nginx。</li>
</ul>
</li>
<li>ALB：Application Load Balancer 运行于请求级别（第 7 层），可根据请求的内容将流量路由至 EC2 实例、容器、IP 地址和 Lambda 函数等目标。Application Load Balancer 最适合 HTTP 和 HTTPS 流量的高级负载均衡，面向交付包括微服务和基于容器的应用程序在内的现代应用程序架构，提供高级请求路由功能。Application Load Balancer 通过确保始终使用最新的 SSL/TLS 密码和协议，简化并提高应用程序的安全性。</li>
<li>NLB：Network Load Balancer 网络负载均衡器运行于连接级别（第 4 层），可根据 IP 协议数据将连接路由至 Amazon Virtual Private Cloud (Amazon VPC) 内的不同目标（Amazon EC2 实例、微服务和容器）。网络负载均衡器最适合 TCP 流量的负载均衡，能够在保持超低延迟的同时每秒处理数百万个请求。网络负载均衡器还经过了优化，能够处理突发的和不稳定的流量模式，同时在每个可用区使用单个静态 IP 地址。它与其他流行的 AWS 服务集成，例如 Auto Scaling、Amazon EC2 Container Service (ECS)、Amazon CloudFormation 和 Amazon AWS Certificate Manager (ACM)。</li>
</ol>
<h3 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h3><p><strong>1、轮询法</strong></p>
<p>将请求按顺序轮流地分配到后端服务器上，它均衡地对待后端的每一台服务器，而不关心服务器实际的连接数和当前的系统负载。</p>
<p><strong>2、随机法</strong></p>
<p>​        通过系统的随机算法，根据后端服务器的列表大小值来随机选取其中的一台服务器进行访问。由概率统计理论可以得知，随着客户端调用服务端的次数增多，其实际效果越来越接近于平均分配调用量到后端的每一台服务器，也就是轮询的结果。</p>
<p><strong>3、源地址哈希法</strong></p>
<p>​        源地址哈希的思想是根据获取客户端的IP地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一IP地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问。</p>
<p><strong>4、加权轮询法</strong></p>
<p>不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，让其处理更多的请；而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</p>
<p><strong>5、加权随机法</strong></p>
<p>​        与加权轮询法一样，加权随机法也根据后端机器的配置，系统的负载分配不同的权重。不同的是，它是按照权重随机请求后端服务器，而非顺序。</p>
<p><strong>6、最小连接数法</strong></p>
<p>​        最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器。</p>
<h3 id="常用负载均衡比较"><a href="#常用负载均衡比较" class="headerlink" title="常用负载均衡比较"></a>常用负载均衡比较</h3><table>
<thead>
<tr>
<th><strong>比较</strong></th>
<th><strong>HAProxy</strong></th>
<th><strong>Nginx</strong></th>
<th><strong>LVS</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>优点</strong></td>
<td><strong>支持session保持，Cookie引导</strong>。  可通过url检测后端服务器健康状态。  也可做MySQL、Email等负载均衡。  支持通过指定的URL对后端服务器健康检查。</td>
<td>http、https、Emai协议功能较好，处理相应请求快。  Web能力强，配置简单，<strong>支持缓存功能</strong>、适用动静分离，低内存消耗。  <strong>支持WebSocket协议</strong>。  <strong>支持强大的正则匹配规则</strong> 。</td>
<td>通过vrrp转发（仅分发）效率高，流量通过内核处理，没有流量产生。（理论）  <strong>相当稳定可靠</strong>。</td>
</tr>
<tr>
<td><strong>缺点</strong></td>
<td>一般不做Web服务器的Cache。</td>
<td>不支持session直接保持，但可通过ip_hash解决。只能通过端口对后端服务器健康检查。</td>
<td>不支持正则，不能做动静分离，配置略复杂，需要IP略多。没有后端主机健康状态检查。</td>
</tr>
<tr>
<td><strong>支持算法</strong></td>
<td>目标uri hash(uri)url参数 (url_params)请求头信息调度(hdr(name))<strong>cookie (rdp-cookie)</strong></td>
<td>最小响应时间**自定义hash内容(hash key [consistent])**url hash最短时间和最少连接</td>
<td>最短期望延迟(Shortest Expected Delay)不排队(Never Queue)基于局部性的最少连接(LBLC)带复制的基于局部性最少链接(LCLBR)</td>
</tr>
<tr>
<td><strong>官网</strong></td>
<td><a target="_blank" rel="noopener" href="http://www.haproxy.com/">www.haproxy.com</a></td>
<td><a target="_blank" rel="noopener" href="http://nginx.org/">nginx.org</a></td>
<td><a target="_blank" rel="noopener" href="http://www.linuxvirtualserver.org/">www.linuxvirtualserver.org</a></td>
</tr>
<tr>
<td><strong>虚拟主机</strong></td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td><strong>适用性</strong></td>
<td>四层，七层（常用）</td>
<td>四层，七层（常用）</td>
<td>四层</td>
</tr>
<tr>
<td><strong>量级</strong></td>
<td>七层重量级，四层轻量级</td>
<td>七层重量级，四层轻量级</td>
<td>四层重量级</td>
</tr>
<tr>
<td><strong>常用热备</strong></td>
<td>Keepalived+其它</td>
<td>Keepalived+其它</td>
<td>Keepalived+其它</td>
</tr>
</tbody></table>
<h2 id="OpenStack负载均衡"><a href="#OpenStack负载均衡" class="headerlink" title="OpenStack负载均衡"></a>OpenStack负载均衡</h2><p><strong>Lbaas V1与V2的区别如下：</strong></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>lbaas</th>
<th>lbaasV2</th>
</tr>
</thead>
<tbody><tr>
<td>最大连接数</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>TCP负载均衡</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>HTTP负载均衡</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>HTTPS负载均衡</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>TERMINATED_HTTPS负载均衡</td>
<td>X</td>
<td>Y</td>
</tr>
<tr>
<td>基于hostname的url转发</td>
<td>X</td>
<td>Y</td>
</tr>
<tr>
<td>基于path的url转发</td>
<td>X</td>
<td>Y</td>
</tr>
<tr>
<td>基于filename的url转发</td>
<td>X</td>
<td>Y</td>
</tr>
<tr>
<td>基于header的url转发</td>
<td>X</td>
<td>Y</td>
</tr>
<tr>
<td>基于cookie的url转发</td>
<td>X</td>
<td>Y</td>
</tr>
<tr>
<td>一个vip支持多种协议和端口</td>
<td>X</td>
<td>Y</td>
</tr>
</tbody></table>
<h2 id="Octavia"><a href="#Octavia" class="headerlink" title="Octavia"></a>Octavia</h2><p>Octavia当前作为OpenStack LbaasV2的一个driver存在，完全兼容lbaasV2的接口，最终的发展趋势会作为一个独立的项目代替lbaasV2。</p>
<p>根据官网的信息，<code>Octavia brings network load balancing to OpenStack.</code>，Octavia是一个NLB的负载均衡。</p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>Octavia就是将用户的API请求经过逻辑处理，<strong>转换成Haproxy或者Nginx的配置参数</strong>，下发到amphora虚机中。</p>
<p>Octavia的内部实现中，逻辑流程的处理主要使用TaskFlow库。</p>
<ul>
<li><strong>LBaas</strong></li>
</ul>
<p>Load Balancing as a Service，在openstack平台上，LB被作为一种服务提供给用户，用户可以按需获取可配置的业务负载分担方案。</p>
<ul>
<li><strong>loadbalancer</strong></li>
</ul>
<p>负载均衡服务的跟对象，一般为虚机，用户基于此对负载均衡进行配置和操作。</p>
<ul>
<li><strong>VIP</strong></li>
</ul>
<p>与LB关联的IP地址，作为<strong>外部访问后端服务</strong>的入口。</p>
<ul>
<li><strong>Listener</strong></li>
</ul>
<p>监听器，用户可通过其配置外部对VIP访问的端口，算法，类型等等。</p>
<ul>
<li><strong>Pool</strong></li>
</ul>
<p>负责后端的虚拟机池。在Haproxy为driver的情况下，一个Pool对应着一个独立的network namespace中运行的HaProxy进程中管理的backend。</p>
<p>一个VIP只会有一个Pool。</p>
<ul>
<li><strong>Member</strong></li>
</ul>
<p>Member 对应的是 pool 里面处理网络请求的一个 OpenStack Nova 虚机。</p>
<ul>
<li><strong>Health monitor</strong></li>
</ul>
<p>它用来检测pool里面的member的状态，支持很多种检测方法，在neutron里面是可选的。</p>
<ul>
<li><strong>L7 Policy</strong></li>
</ul>
<p><strong>七层转发策略</strong>，描述数据包转发动作。</p>
<ul>
<li><strong>L7 Rule</strong></li>
</ul>
<p><strong>七层转发规则</strong>，描述数据包转发的<strong>匹配域</strong>。（匹配<strong>部分</strong>云主机）</p>
<p><img src="/2022/01/26/octavia/1628496-20190718210436501-155725218.png" alt="forward.png"></p>
<h3 id="架构模型"><a href="#架构模型" class="headerlink" title="架构模型"></a>架构模型</h3><p><img src="/2022/01/26/octavia/octavia-component-overview.svg" alt="Octavia组件概述"></p>
<h3 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h3><p><img src="/2022/01/26/octavia/1628496-20190706173729852-17637913.png" alt="network.png"></p>
<ul>
<li><strong>Amphora</strong></li>
</ul>
<p>负载均衡的载体，一般为<strong>云主机</strong>。（当然也可以使用物理机，将多个负载均衡配置到同一/两台Amphora节点上，提高数据包转发效率，但是有<strong>单点故障隐患</strong>）</p>
<ul>
<li><strong>manage-network</strong></li>
</ul>
<p>管理网络，通常管理数据走这条线路，<strong>东侧连接Amphora</strong>，<strong>西侧连接Octavia服务进程</strong>。</p>
<ul>
<li><strong>tenant-network</strong></li>
</ul>
<p>租户网络，<strong>内部通信使用</strong>，SLB转发报文通过租户网络到各个后端服务器上。</p>
<ul>
<li><strong>vip-network</strong></li>
</ul>
<p>服务地址，主要用于<strong>对外提供服务</strong>。</p>
<p>PS：vip-net和tenant-net可以是同一个网络，但是在生产环境中建议分开，以便于更好得划分<strong>网络安全隔离</strong>。</p>
<ul>
<li><strong>VM</strong></li>
</ul>
<p>后端服务器，用户的真实服务器。</p>
<ul>
<li><strong>health-manager</strong></li>
</ul>
<p>octavia里面进行健康检查的进程，主要有以下两个作用：</p>
<ol>
<li><p><strong>监听来自amphora虚拟机发来的运行状态数据</strong>，以此更新lb，listener，pool，member的状态，同时更新listener_statistics表（可作为计费依据），最重要的是更新<strong>amphora_health</strong>表。</p>
</li>
<li><p>根据<strong>amphora_health</strong>数据表中的数据，找到异常状态的amphora虚拟机，对该虚拟机进行<strong>更换操作</strong>。（即删除旧的虚拟机，创建新的虚拟机并下发配置）</p>
</li>
</ol>
<ul>
<li><strong>house-keeping</strong></li>
</ul>
<p>名副其实的 Housekeeping（家政）服务，保障 Octavia 的健康运行。</p>
<p>主要实现三个功能：</p>
<ol>
<li><p>SpareAmphora: <strong>清理虚拟机的池子</strong>, 确保空闲的amphorae池大小。</p>
</li>
<li><p>DatabaseCleanup: <strong>定期清理数据库</strong>中已删除的amphorae记录。</p>
</li>
<li><p>CertRotation: <strong>定期更新</strong>amphorae中的<strong>证书</strong>。</p>
</li>
</ol>
<ul>
<li><strong>Octavia Worker</strong></li>
</ul>
<p>负责完成 API 请求，是 <strong>Octavia 主干功能的执行者</strong>。</p>
<p>主要作用是和nova，neutron等组件通信，用于虚拟机调度以及把对于虚拟机操作的指令下发给octavia agent。</p>
<h3 id="请求流程"><a href="#请求流程" class="headerlink" title="请求流程"></a>请求流程</h3><p><img src="/2022/01/26/octavia/1628496-20190718210511452-1147299861.png" alt="request.png"></p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="1-创建负载均衡"><a href="#1-创建负载均衡" class="headerlink" title="1. 创建负载均衡"></a>1. 创建负载均衡</h3><p>通过页面创建负载均衡</p>
<h3 id="2-查看LB详情"><a href="#2-查看LB详情" class="headerlink" title="2. 查看LB详情"></a>2. 查看LB详情</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack loadbalancer show &#123;lbId&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/26/octavia/image-20210302181609960.png" alt="image-20210302181609960"></p>
<p>通过查看详情，知道<code>provider</code>是<code>amphora</code>;</p>
<p>创建时选择的vpc信息最终生成的ip是一个<strong>VIP</strong>；</p>
<h3 id="3-查看service项目下的vm信息"><a href="#3-查看service项目下的vm信息" class="headerlink" title="3. 查看service项目下的vm信息"></a>3. 查看service项目下的vm信息</h3><h4 id="负载均衡的虚拟机"><a href="#负载均衡的虚拟机" class="headerlink" title="负载均衡的虚拟机"></a>负载均衡的虚拟机</h4><p>然后查看<code>service</code>项目下的虚拟机信息，发现有多个：</p>
<p><img src="/2022/01/26/octavia/image-20210302182010345.png" alt="image-20210302182010345"></p>
<p>这些虚拟机中，最主要的服务就是：<strong>haproxy、octavia-keepalived和amphora-agent服务</strong>；</p>
<ul>
<li><p><strong>haproxy、octavia-keepalived</strong>：通过这两个服务实现负载均衡；</p>
</li>
<li><p><strong>amphora-agent</strong>：提供Octavia API，并且定时向<strong>health-monitor</strong>发送haproxy的运行时信息，该信息是通过向haproxy进程发送socket查询命令获取到；</p>
</li>
</ul>
<p>存在多个<strong>amphora云主机</strong>是因为开启了集群模式，可以通过查看<code>octavia-api</code>中<code>/etc/octavia/octavia.conf</code>配置文件内容来确认。</p>
<ol>
<li><p><code>SINGLE</code>：单机</p>
</li>
<li><p><code>ACTIVE_STANDBY</code> ：高可用模式(主备模式)</p>
</li>
</ol>
<p><img src="/2022/01/26/octavia/image-20210302183609566.png" alt="image-20210302183609566"></p>
<p>同时可以看到，每个<strong>amphora云主机</strong>都使用了两个网络，一个是<strong>lb-mgmt-net</strong>，一个是租户网络(创建负载均衡的时候选择的VPC，也是云主机所在的VPC)，同时Octavia每创建一个 loadbalancer，都会创建包含同样 policy 的 server group(反亲和组)，没有所属租户，用户可见。</p>
<p><em><strong>即：创建 loadbalancer 的租户只能看到这个 loadbalancer 的信息以及 loadbalancer 所占用的 port（VIP的port）信息，背后的VM、VM的port、SecurityGroup、ServerGroup 都是不可见的。一个 lb 的创建会占用租户 subnet 内的 ip 资源和 port 配额（一般会在 subnet 中创建3个 port）。</strong></em></p>
<p><img src="/2022/01/26/octavia/image-20210303152421902.png" alt="image-20210303152421902"></p>
<p>可以看到，这个反亲和组中，默认就添加了amphora的两台机器：</p>
<p><img src="/2022/01/26/octavia/image-20210303152448987.png" alt="image-20210303152448987"></p>
<p>在 octavia 中，资源之间的映射关系如下：</p>
<ul>
<li>lb：就是两个管理员租户的虚拟机</li>
<li>listener：虚拟机里面的一个 haproxy 进程，frontend 配置</li>
<li>pool：haproxy 配置中的一个 backend</li>
<li>member：backend 配置中的一个 member</li>
</ul>
<h4 id="负载均衡的listener"><a href="#负载均衡的listener" class="headerlink" title="负载均衡的listener"></a>负载均衡的listener</h4><p>创建listener其实就是启动haproxy服务，大致分为如下步骤：</p>
<ol>
<li>将haproxy的配置文件传到amphora虚拟机中；</li>
<li>根据虚拟机信息，进行配置修改；</li>
<li>amphora-agent调用<code>haproxy -c -L &#123;peer&#125; -f &#123;config_file&#125; -f &#123;haproxy_ug&#125;</code>校验配置文件；</li>
<li>验证无误之后，生成对应该listener的haproxy服务脚本；</li>
<li>通过amphora-agent启动amphora虚拟机中haproxy服务；<ol>
<li>先确定listener的配置目录（<code>/var/lib/octavia/&#123;listener-id&#125;/</code>）在不在</li>
<li>如果是active standby，更新keepalived对各个haproxy的check脚本，<code>/var/lib/octavia/vrrp/check_scripts/haproxy_check_script.sh</code></li>
<li>启动haproxy服务，<code>service haproxy-&#123;listener_id&#125; start</code></li>
</ol>
</li>
</ol>
<h4 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h4><p>创建pool的实现基本跟创建listener一致，在amphora中仅仅是在 haproxy 的配置文件增加<code>backend</code>配置；</p>
<h4 id="添加members"><a href="#添加members" class="headerlink" title="添加members"></a>添加members</h4><p>添加members需要保证网络可达，在OpenStack中，只能选同一子网的云主机，所以网络是连通的；</p>
<p>octavia已经支持直接指定IP地址添加membe，而不跟虚拟机绑定，前提是用户自己需要保证amphora能够与这个IP地址通信。这种情况最好能在pool上添加 <code>health_monitor</code> 来保证 member 的可用性，这样如果ip地址不可达时，lb也不会将消息路由给它。（OpenStack是在同一子网，可以不开启健康检查）</p>
<p>因为与member通信的 port 都在namespace中，所以管理 IP 段就可以与租户的网络重叠。</p>
<h3 id="4-负载均衡实现方式验证"><a href="#4-负载均衡实现方式验证" class="headerlink" title="4. 负载均衡实现方式验证"></a>4. 负载均衡实现方式验证</h3><p>此时，可以通过查看<code>service</code>项目下的虚拟机，来验证<code>Octavia</code>的相关配置是否如预期：</p>
<p>ssh到<code>service</code>项目下两台虚拟机其中的一台，使用<code>lb-mgmt-net</code>网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh &#123;lb-mgmt-net&#125;</span><br><span class="line">ps -ef |grep keepalived;</span><br><span class="line">cat  /var/lib/octavia/vrrp/octavia-keepalived.conf</span><br></pre></td></tr></table></figure>

<p>然后会看到具体的配置，总体来说<code>octavia</code>的高可用是通过<strong>haproxy+keepalived</strong>来完成的。</p>
<h3 id="5-验证负载均衡"><a href="#5-验证负载均衡" class="headerlink" title="5. 验证负载均衡"></a>5. 验证负载均衡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack loadbalancer show &#123;lbId&#125;  ## 得到vip_network_id</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 然后根据这个id，查询对应的路由信息</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 最终得到路由的id</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 也可以直接通过页面拿到对应的路由的ID</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 执行ip netns 得到对应的网络</span></span></span><br><span class="line">ip netns | grep &#123;routerId&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 执行一下ping，是否可以连通</span></span></span><br><span class="line">ip netns exec qrouter-&#123;routerId&#125; ping &#123;lbVip&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 根据负载均衡选择的监听方式进行验证，此处负载均衡是监听的22端口，进行ssh验证</span></span></span><br><span class="line">ip netns exec qrouter-&#123;routerId&#125; ssh &#123;lbVip&#125;</span><br></pre></td></tr></table></figure>

<p>负载均衡的监听器，监听的是22端口：</p>
<p><img src="/2022/01/26/octavia/image-20210303141525891.png" alt="image-20210303141525891"></p>
<p>查看<code>22pool</code>资源池，映射的也是22端口：</p>
<p><img src="/2022/01/26/octavia/image-20210303141623791.png" alt="image-20210303141623791"></p>
<p>然后进行ping的验证：</p>
<p><img src="/2022/01/26/octavia/image-20210303140307409.png" alt="image-20210303140307409"></p>
<p>ssh验证：</p>
<p><img src="/2022/01/26/octavia/image-20210303140336380.png" alt="image-20210303140336380"></p>
<p>输入密码登录之后，通过<code>ip a</code>查看网卡信息，可以看到此时连到了负载均衡下面资源池中的一台云主机。</p>
<p>参考： <a target="_blank" rel="noopener" href="https://lingxiankong.github.io/2017-09-13-octavia.html">https://lingxiankong.github.io/2017-09-13-octavia.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Liu Fujun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://liu-fujun.github.io/2022/01/26/octavia/">https://liu-fujun.github.io/2022/01/26/octavia/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://liu-fujun.github.io" target="_blank">Liu's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OpenStack/">OpenStack</a><a class="post-meta__tags" href="/tags/octavia/">octavia</a><a class="post-meta__tags" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a></div><div class="post_share"><div class="social-share" data-image="/img/openstack.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/01/26/sg-firewall/"><img class="prev-cover" src="/img/openstack.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">安全组与防火墙</div></div></a></div><div class="next-post pull-right"><a href="/2022/01/23/rbac1/"><img class="next-cover" src="/img/RBAC.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">关于RBAC的总结-上</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/26/sg-firewall/" title="安全组与防火墙"><img class="cover" src="/img/openstack.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-26</div><div class="title">安全组与防火墙</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/LFJ.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Liu Fujun</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liu-fujun" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎大家光临小站~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.</span> <span class="toc-text">什么是负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">负载均衡的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%86%E7%B1%BB"><span class="toc-number">3.</span> <span class="toc-text">负载均衡分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">负载均衡算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%AF%94%E8%BE%83"><span class="toc-number">5.</span> <span class="toc-text">常用负载均衡比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenStack%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number"></span> <span class="toc-text">OpenStack负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Octavia"><span class="toc-number"></span> <span class="toc-text">Octavia</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">架构模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">网络模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">请求流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number"></span> <span class="toc-text">具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.</span> <span class="toc-text">1. 创建负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8BLB%E8%AF%A6%E6%83%85"><span class="toc-number">2.</span> <span class="toc-text">2. 查看LB详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8Bservice%E9%A1%B9%E7%9B%AE%E4%B8%8B%E7%9A%84vm%E4%BF%A1%E6%81%AF"><span class="toc-number">3.</span> <span class="toc-text">3. 查看service项目下的vm信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.1.</span> <span class="toc-text">负载均衡的虚拟机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84listener"><span class="toc-number">3.2.</span> <span class="toc-text">负载均衡的listener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pool"><span class="toc-number">3.3.</span> <span class="toc-text">pool</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0members"><span class="toc-number">3.4.</span> <span class="toc-text">添加members</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E9%AA%8C%E8%AF%81"><span class="toc-number">4.</span> <span class="toc-text">4. 负载均衡实现方式验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%AA%8C%E8%AF%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.</span> <span class="toc-text">5. 验证负载均衡</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/02/09/deploy-desc/" title="关于蓝绿发布、灰度以及滚动发布的记录"><img src="/img/river.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="关于蓝绿发布、灰度以及滚动发布的记录"/></a><div class="content"><a class="title" href="/2022/02/09/deploy-desc/" title="关于蓝绿发布、灰度以及滚动发布的记录">关于蓝绿发布、灰度以及滚动发布的记录</a><time datetime="2022-02-09T07:57:59.000Z" title="发表于 2022-02-09 15:57:59">2022-02-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/08/k8s-schedule/" title="k8s-schedule"><img src="/img/river.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s-schedule"/></a><div class="content"><a class="title" href="/2022/02/08/k8s-schedule/" title="k8s-schedule">k8s-schedule</a><time datetime="2022-02-08T07:43:14.000Z" title="发表于 2022-02-08 15:43:14">2022-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/08/k8s-network/" title="k8s-network"><img src="/img/river.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s-network"/></a><div class="content"><a class="title" href="/2022/02/08/k8s-network/" title="k8s-network">k8s-network</a><time datetime="2022-02-08T07:42:48.000Z" title="发表于 2022-02-08 15:42:48">2022-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/08/k8s-security/" title="k8s-security"><img src="/img/river.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s-security"/></a><div class="content"><a class="title" href="/2022/02/08/k8s-security/" title="k8s-security">k8s-security</a><time datetime="2022-02-08T07:42:37.000Z" title="发表于 2022-02-08 15:42:37">2022-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/08/k8s-config/" title="k8s-config"><img src="/img/river.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s-config"/></a><div class="content"><a class="title" href="/2022/02/08/k8s-config/" title="k8s-config">k8s-config</a><time datetime="2022-02-08T07:42:27.000Z" title="发表于 2022-02-08 15:42:27">2022-02-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By Liu Fujun</div><!--if theme.footer.copyright--><!--  .framework-info--><!--    span= _p('footer.framework') + ' '--><!--    a(href='https://hexo.io')= 'Hexo'--><!--    span.footer-separator |--><!--    span= _p('footer.theme') + ' '--><!--    a(href='https://github.com/jerryc127/hexo-theme-butterfly')= 'Butterfly'--><div class="footer_custom_text">每天进步一点点</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>